{"version":3,"file":"matroska-subtitles.umd.js","sources":["../src/subtitle-parser-base.js","../src/subtitle-parser.js","../src/subtitle-stream.js"],"sourcesContent":["import { PassThrough } from 'readable-stream'\r\nimport { EbmlStreamDecoder, EbmlTagId } from 'ebml-stream'\r\nimport { inflateSync } from 'zlib'\r\n\r\nconst SSA_TYPES = new Set(['ssa', 'ass'])\r\nconst SSA_KEYS = ['readOrder', 'layer', 'style', 'name', 'marginL', 'marginR', 'marginV', 'effect', 'text']\r\n\r\nfunction getChild (chunk, tag) {\r\n  return chunk?.Children.find(({ id }) => id === tag)\r\n}\r\nfunction getData (chunk, tag) {\r\n  return getChild(chunk, tag)?.data\r\n}\r\n\r\nexport class SubtitleParserBase extends PassThrough {\r\n  constructor () {\r\n    super()\r\n\r\n    this.subtitleTracks = new Map()\r\n    this.timecodeScale = 1\r\n\r\n    this._currentClusterTimecode = null\r\n\r\n    this.decoder = new EbmlStreamDecoder({\r\n      bufferTagIds: [\r\n        EbmlTagId.TimecodeScale,\r\n        EbmlTagId.Tracks,\r\n        EbmlTagId.BlockGroup,\r\n        EbmlTagId.AttachedFile,\r\n        EbmlTagId.Chapters,\r\n        EbmlTagId.Duration\r\n      ]\r\n    })\r\n\r\n    const tagMap = {\r\n      // Segment Information\r\n      [EbmlTagId.TimecodeScale]: ({ data }) => {\r\n        this.timecodeScale = data / 1000000\r\n      },\r\n      // Assumption: This is a Cluster `Timecode`\r\n      [EbmlTagId.Timecode]: ({ data }) => {\r\n        this._currentClusterTimecode = data\r\n      },\r\n      // Parse attached files, mainly to allow extracting subtitle font files.\r\n      [EbmlTagId.AttachedFile]: chunk => {\r\n        this.emit('file', {\r\n          filename: getData(chunk, EbmlTagId.FileName),\r\n          mimetype: getData(chunk, EbmlTagId.FileMimeType),\r\n          data: getData(chunk, EbmlTagId.FileData)\r\n        })\r\n      },\r\n      // Duration for chapters which don't specify an end position\r\n      [EbmlTagId.Duration]: ({ data }) => {\r\n        this.duration = data\r\n      },\r\n      [EbmlTagId.Tracks]: this.handleTracks.bind(this),\r\n      [EbmlTagId.BlockGroup]: this.handleBlockGroup.bind(this),\r\n      [EbmlTagId.Chapters]: this.handleChapters.bind(this)\r\n    }\r\n    this.decoder.on('data', chunk => {\r\n      tagMap[chunk.id]?.(chunk)\r\n    })\r\n  }\r\n\r\n  handleTracks (chunk) {\r\n    for (const entry of chunk.Children.filter(c => c.id === EbmlTagId.TrackEntry)) {\r\n      // Skip non subtitle tracks\r\n      if (getData(entry, EbmlTagId.TrackType) !== 0x11) continue\r\n\r\n      const codecID = getData(entry, EbmlTagId.CodecID) || ''\r\n      if (codecID.startsWith('S_TEXT')) {\r\n        const track = {\r\n          number: getData(entry, EbmlTagId.TrackNumber),\r\n          language: getData(entry, EbmlTagId.Language),\r\n          type: codecID.substring(7).toLowerCase()\r\n        }\r\n\r\n        const name = getData(entry, EbmlTagId.Name)\r\n        if (name) track.name = name\r\n\r\n        const header = getData(entry, EbmlTagId.CodecPrivate)\r\n        if (header) track.header = header.toString()\r\n\r\n        // TODO: Assume zlib deflate compression\r\n        const compressed = entry.Children.find(c =>\r\n          c.id === EbmlTagId.ContentEncodings &&\r\n          c.Children.find(cc =>\r\n            cc.id === EbmlTagId.ContentEncoding &&\r\n            getChild(cc, EbmlTagId.ContentCompression)\r\n          )\r\n        )\r\n\r\n        if (compressed) track._compressed = true\r\n\r\n        this.subtitleTracks.set(track.number, track)\r\n      }\r\n    }\r\n\r\n    this.emit('tracks', [...this.subtitleTracks.values()])\r\n  }\r\n\r\n  handleBlockGroup (chunk) {\r\n    const block = getChild(chunk, EbmlTagId.Block)\r\n\r\n    if (block && this.subtitleTracks.has(block.track)) {\r\n      const blockDuration = getData(chunk, EbmlTagId.BlockDuration)\r\n      const track = this.subtitleTracks.get(block.track)\r\n\r\n      const payload = track._compressed\r\n        ? inflateSync(Buffer.from(block.payload))\r\n        : block.payload\r\n\r\n      const subtitle = {\r\n        text: payload.toString('utf8'),\r\n        time: (block.value + this._currentClusterTimecode) * this.timecodeScale,\r\n        duration: blockDuration * this.timecodeScale\r\n      }\r\n\r\n      if (SSA_TYPES.has(track.type)) {\r\n        // extract SSA/ASS keys\r\n        const values = subtitle.text.split(',')\r\n\r\n        // ignore read-order, and skip layer if ssa\r\n        for (let i = track.type === 'ssa' ? 2 : 1; i < 8; i++) {\r\n          subtitle[SSA_KEYS[i]] = values[i]\r\n        }\r\n\r\n        subtitle.text = values.slice(8).join(',')\r\n      }\r\n\r\n      this.emit('subtitle', subtitle, block.track)\r\n    }\r\n  }\r\n\r\n  handleChapters ({ Children }) {\r\n    const editions = Children.filter(c => c.id === EbmlTagId.EditionEntry)\r\n    // https://www.matroska.org/technical/chapters.html#default-edition\r\n    // finds first default edition, or first entry\r\n    const defaultEdition = editions.find(c => {\r\n      return c.Children.some(cc => {\r\n        return cc.id === EbmlTagId.EditionFlagDefault && Boolean(cc.data)\r\n      })\r\n    }) || editions[0]\r\n\r\n    // exclude hidden atoms\r\n    const atoms = defaultEdition.Children.filter(c => c.id === EbmlTagId.ChapterAtom && !getData(c, EbmlTagId.ChapterFlagHidden))\r\n    const chapters = []\r\n    for (let i = atoms.length - 1; i >= 0; --i) {\r\n      const start = getData(atoms[i], EbmlTagId.ChapterTimeStart) / this.timecodeScale / 1000000\r\n      const end = (getData(atoms[i], EbmlTagId.ChapterTimeEnd) / this.timecodeScale / 1000000) || chapters[i + 1]?.start || this.duration\r\n      const disp = getChild(atoms[i], EbmlTagId.ChapterDisplay)\r\n\r\n      chapters[i] = {\r\n        start,\r\n        end,\r\n        text: getData(disp, EbmlTagId.ChapString),\r\n        language: getData(disp, EbmlTagId.ChapLanguage)\r\n      }\r\n    }\r\n    this.emit('chapters', chapters)\r\n  }\r\n}\r\n","import { EbmlTagId } from 'ebml-stream'\r\nimport { SubtitleParserBase } from './subtitle-parser-base'\r\n\r\nexport class SubtitleParser extends SubtitleParserBase {\r\n  constructor () {\r\n    super()\r\n\r\n    this.decoder.on('data', (chunk) => {\r\n      if (chunk.id === EbmlTagId.Tracks) {\r\n        // stop decoding if no subtitle tracks are present\r\n        if (this.subtitleTracks.size === 0) this.end()\r\n      }\r\n    })\r\n  }\r\n\r\n  _write (chunk, _, callback) {\r\n    this.decoder.write(chunk)\r\n    callback(null, chunk)\r\n  }\r\n}\r\n","import { SubtitleParserBase } from './subtitle-parser-base'\r\nimport { EbmlTagId } from 'ebml-stream'\r\n\r\nexport class SubtitleStream extends SubtitleParserBase {\r\n  constructor (prevInstance) {\r\n    super()\r\n\r\n    if (prevInstance instanceof SubtitleParserBase) {\r\n      prevInstance.once('drain', () => prevInstance.end())\r\n\r\n      // copy previous metadata\r\n      this.subtitleTracks = prevInstance.subtitleTracks\r\n      this.timecodeScale = prevInstance.timecodeScale\r\n\r\n      // may not be at ebml tag offset\r\n      this.unstable = true\r\n    }\r\n    this.on('data', this._ondata.bind(this))\r\n  }\r\n\r\n  // passthrough stream: data is intercepted but not transformed\r\n  _ondata (chunk) {\r\n    if (this.unstable) {\r\n      // the ebml decoder expects to see a tag, so we won't use it until we find a cluster\r\n      for (let i = 0; i < chunk.length - 12; i++) {\r\n        // cluster id 0x1F43B675\r\n        // https://matroska.org/technical/elements.html#LevelCluster\r\n        if (chunk[i] === 0x1f && chunk[i + 1] === 0x43 && chunk[i + 2] === 0xb6 && chunk[i + 3] === 0x75) {\r\n          // length of cluster size tag\r\n          const len = 8 - Math.floor(Math.log2(chunk[i + 4]))\r\n          // first tag in cluster is a valid EbmlTag\r\n          if (EbmlTagId[chunk[i + 4 + len]]) {\r\n            // okay this is probably a cluster\r\n            this.unstable = false\r\n            this.decoderWrite(chunk.slice(i))\r\n            return\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      this.decoderWrite(chunk)\r\n    }\r\n  }\r\n\r\n  decoderWrite (chunk) {\r\n    // passthrough stream should allow chained streams to continue on error\r\n    try {\r\n      this.decoder.write(chunk)\r\n    } catch (err) {\r\n      console.warn('[matroska-subtitles] EBML stream decoding error', err)\r\n    }\r\n  }\r\n}\r\n"],"names":["SSA_TYPES","Set","SSA_KEYS","getChild","chunk","tag","Children","find","id","getData","data","SubtitleParserBase","PassThrough","constructor","subtitleTracks","Map","timecodeScale","_currentClusterTimecode","decoder","EbmlStreamDecoder","bufferTagIds","EbmlTagId","TimecodeScale","Tracks","BlockGroup","AttachedFile","Chapters","Duration","tagMap","Timecode","emit","filename","FileName","mimetype","FileMimeType","FileData","duration","handleTracks","bind","handleBlockGroup","handleChapters","on","entry","filter","c","TrackEntry","TrackType","codecID","CodecID","startsWith","track","number","TrackNumber","language","Language","type","substring","toLowerCase","name","Name","header","CodecPrivate","toString","compressed","ContentEncodings","cc","ContentEncoding","ContentCompression","_compressed","set","values","block","Block","has","blockDuration","BlockDuration","get","payload","inflateSync","Buffer","from","subtitle","text","time","value","split","i","slice","join","editions","EditionEntry","defaultEdition","some","EditionFlagDefault","Boolean","atoms","ChapterAtom","ChapterFlagHidden","chapters","length","start","ChapterTimeStart","end","ChapterTimeEnd","disp","ChapterDisplay","ChapString","ChapLanguage","SubtitleParser","size","_write","_","callback","write","SubtitleStream","prevInstance","once","unstable","_ondata","len","Math","floor","log2","decoderWrite","err","console","warn"],"mappings":"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"}